name: CI

on:
  push:
    branches: [main]
  pull_request:

jobs:
  php-ci:
    runs-on: ubuntu-latest
    name: Análisis de PHP

    steps:
      - name: Checkout del código
        uses: actions/checkout@v4

      - name: Cache Composer
        uses: actions/cache@v4
        with:
          path: vendor
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'

      - name: Instalar dependencias PHP
        run: |
          if [ -f composer.json ]; then
            composer install --no-interaction --prefer-dist
          fi

      - name: PHPStan - Análisis estático
        run: |
          if [ -f vendor/bin/phpstan ]; then
            vendor/bin/phpstan analyse backend/ --level=max
          else
            echo "phpstan no está instalado."
          fi

      - name: PHP_CodeSniffer - Estilo de código
        run: |
          if [ -f vendor/bin/phpcs ]; then
            vendor/bin/phpcs backend/ --standard=PSR12
          else
            echo "phpcs no está instalado."
          fi

  frontend-ci:
    runs-on: ubuntu-latest
    name: Análisis de HTML, CSS y JS

    steps:
      - name: Checkout del código
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Instalar dependencias de Node
        run: |
          if [ -f package.json ]; then
            npm ci
          else
            npm init -y
            npm install --save-dev eslint stylelint htmlhint prettier jest
          fi

      - name: ESLint - Análisis JS
        run: |
          npx eslint . --ext .js || exit 1

      - name: Stylelint - Análisis CSS
        run: |
          npx stylelint "**/*.css" || exit 1

      - name: HTMLHint - Validación HTML
        run: |
          npx htmlhint "**/*.html" || exit 1

      - name: Prettier - Validación de formato
        run: |
          npx prettier . --check || exit 1

      - name: Jest - Pruebas JS (si aplica)
        run: |
          if [ -f node_modules/.bin/jest ]; then
            npx jest
          else
            echo "Jest no configurado. Saltando pruebas JS."
          fi
